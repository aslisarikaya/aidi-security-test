#cloud-config
package_update: true
packages:
  # Install necessary packages
  - sudo
  - curl
  - docker.io

runcmd:

  # 1. Setup User Permissions
  - usermod -aG sudo ubuntu
  - echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/90-cloud-init-users

  # -------------------------------------------------------------------------
  # ULTRA-ROBUST DEPLOYMENT SCRIPT
  # This script guarantees the non-interactive Docker login works.
  # -------------------------------------------------------------------------
  - |
    # Explicitly run the core logic using the sh interpreter
    /bin/sh -c '
      echo "--- Starting Ultra-Robust Docker Deployment ---"
      
      # 2. Login to GHCR securely (Fix for "non TTY device")
      export GHCR_TOKEN="${ghcr_pull_token}"
      echo "Logging into ghcr.io using user: ${github_username}"
      
      # Non-interactive login fix using --password-stdin
      echo $GHCR_TOKEN | docker login ghcr.io -u ${github_username} --password-stdin
      # Security: Immediately clear the token variable
      unset GHCR_TOKEN 

      # 3. Pull and Run the application container (Fix for "invalid reference format")
      FULL_IMAGE_NAME="ghcr.io/${ghcr_image_path}:${ghcr_image_tag}"
      echo "Pulling image: $FULL_IMAGE_NAME"
      docker pull $FULL_IMAGE_NAME
      
      # 4. Start the container
      echo "Starting container: price-server on port 80"
      docker run -d -p 80:80 --name price-server --restart=always $FULL_IMAGE_NAME

      # 5. Clean up
      docker system prune -f
      echo "--- Deployment Complete ---"
    '